name: 'GDSmeller - GDScript Static Analysis'
description: 'Static analysis tool for GDScript that detects code smells and common issues'
author: 'dgorshkov'

branding:
  icon: 'check-circle'
  color: 'blue'

inputs:
  path:
    description: 'Path to the GDScript files or directory to analyze'
    required: false
    default: '.'
  config:
    description: 'Path to configuration file'
    required: false
    default: ''
  fail-on-warning:
    description: 'Fail if warnings are found'
    required: false
    default: 'false'
  output-format:
    description: 'Output format (text, json, github)'
    required: false
    default: 'github'

outputs:
  issues-count:
    description: 'Number of issues found'
  warnings-count:
    description: 'Number of warnings found'

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Run GDSmeller
      shell: bash
      run: |
        # Run GDSmeller in JSON mode first to extract machine-readable counts
        GDSMELLER_JSON_OUTPUT="$(
          python ${{ github.action_path }}/gdsmeller/main.py \
            --path "${{ inputs.path }}" \
            --output-format "json" \
            ${{ inputs.config != '' && format('--config "{0}"', inputs.config) || '' }} \
            2>/dev/null || echo '{}'
        )"
        
        # Parse issues and warnings counts from the JSON output using Python stdlib
        COUNTS="$(
          python - << 'EOF'
import json
import os
import sys
try:
    data = json.loads(os.environ.get("GDSMELLER_JSON_OUTPUT", "{}"))
    summary = data.get("summary", {})
    by_severity = summary.get("by_severity", {})
    issues = summary.get("total", 0)
    warnings = by_severity.get("warning", 0)
    print(f"{issues} {warnings}")
except:
    print("0 0")
EOF
        )"
        
        ISSUES_COUNT="$(echo "$COUNTS" | awk '{print $1}')"
        WARNINGS_COUNT="$(echo "$COUNTS" | awk '{print $2}')"
        
        {
          echo "issues-count=$ISSUES_COUNT"
          echo "warnings-count=$WARNINGS_COUNT"
        } >> "$GITHUB_OUTPUT"
        
        # Run GDSmeller with the requested output format (may fail if issues found)
        python ${{ github.action_path }}/gdsmeller/main.py \
          --path "${{ inputs.path }}" \
          --output-format "${{ inputs.output-format }}" \
          ${{ inputs.config != '' && format('--config "{0}"', inputs.config) || '' }} \
          ${{ inputs.fail-on-warning == 'true' && '--fail-on-warning' || '' }}
